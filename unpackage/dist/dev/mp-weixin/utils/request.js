"use strict";const n=require("../common/vendor.js"),o={baseURL:"https://bxgm.cklock.cn",timeout:6e4,headers:{"Content-Type":"application/json"},showLoading:!0,loadingText:"请求中...",showError:!0};let c=[];function m(e=o.loadingText){c.length===0&&n.index.showLoading({title:e,mask:!0}),c.push(1)}function f(){c.pop(),c.length===0&&n.index.hideLoading()}function E(){return n.index.getStorageSync("token")||""}function x(e){const r=E();return r&&(e.header={...e.header,Authorization:`Bearer ${r}`}),e.url.startsWith("http")||(e.url=o.baseURL+e.url),e.timeout=e.timeout||o.timeout,e.showLoading!==!1&&o.showLoading&&m(e.loadingText),n.index.__f__("log","at utils/request.js:89","请求发送:",e),e}function L(e,r){r.showLoading!==!1&&o.showLoading&&f(),n.index.__f__("log","at utils/request.js:102","响应接收:",e);const{statusCode:t,data:s}=e;if(t===200){if(s.code===0||s.success===!0)return Promise.resolve(s);{const i=s.message||s.msg||"请求失败";return s.code===401||s.code===403?(_(),Promise.reject(new Error("登录已过期，请重新登录"))):(r.showError!==!1&&o.showError&&n.index.showToast({title:i,icon:"none",duration:2e3}),Promise.reject(new Error(i)))}}else{const i=M(t);return r.showError!==!1&&o.showError&&n.index.showToast({title:i,icon:"none",duration:2e3}),Promise.reject(new Error(i))}}function T(e,r){r.showLoading!==!1&&o.showLoading&&f(),n.index.__f__("error","at utils/request.js:156","请求错误:",e);let t="网络请求失败";return e.errMsg&&(e.errMsg.includes("timeout")?t="请求超时，请检查网络连接":e.errMsg.includes("fail")&&(t="网络连接失败，请检查网络")),r.showError!==!1&&o.showError&&n.index.showToast({title:t,icon:"none",duration:2e3}),Promise.reject(new Error(t))}function _(){n.index.removeStorageSync("token"),n.index.removeStorageSync("userInfo"),n.index.removeStorageSync("isLoggedIn"),setTimeout(()=>{n.index.reLaunch({url:"/pages/login/login"})},1500)}function M(e){return{400:"请求参数错误",401:"未授权，请登录",403:"拒绝访问",404:"请求地址不存在",408:"请求超时",500:"服务器内部错误",502:"网关错误",503:"服务不可用",504:"网关超时"}[e]||`请求失败 (${e})`}function u(e){return new Promise((r,t)=>{const s=x({...o.headers&&{header:o.headers},...e});n.index.request({...s,success:i=>{L(i,e).then(r).catch(t)},fail:i=>{T(i,e).catch(t)}})})}function q(e,r={},t={}){return u({url:e,method:"GET",data:r,...t})}function S(e,r={},t={}){return u({url:e,method:"POST",data:r,...t})}function P(e,r={},t={}){return u({url:e,method:"PUT",data:r,...t})}function k(e,r={},t={}){return u({url:e,method:"DELETE",data:r,...t})}function j(e,r,t={},s={}){return new Promise((i,d)=>{const h=E(),g={...s.header};h&&(g.Authorization=`Bearer ${h}`),e.startsWith("http")||(e=o.baseURL+e),s.showLoading!==!1&&o.showLoading&&m("上传中..."),n.index.uploadFile({url:e,filePath:r,name:s.name||"file",formData:t,header:g,success:l=>{try{const a=JSON.parse(l.data);if(a.code===0||a.success===!0)i(a);else{const w=a.message||a.msg||"上传失败";s.showError!==!1&&o.showError&&n.index.showToast({title:w,icon:"none"}),d(new Error(w))}}catch{d(new Error("响应数据解析失败"))}},fail:l=>{const a="上传失败，请重试";s.showError!==!1&&o.showError&&n.index.showToast({title:a,icon:"none"}),d(new Error(a))},complete:()=>{s.showLoading!==!1&&o.showLoading&&f()}})})}function y(e){Object.assign(o,e)}function b(){return{...o}}const v={request:u,get:q,post:S,put:P,delete:k,upload:j,setConfig:y,getConfig:b};exports.request=v;
//# sourceMappingURL=../../.sourcemap/mp-weixin/utils/request.js.map
