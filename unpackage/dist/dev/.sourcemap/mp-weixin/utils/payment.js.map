{"version":3,"file":"payment.js","sources":["utils/payment.js"],"sourcesContent":["/**\n * 支付工具类\n */\n\n// 微信支付配置\nconst WECHAT_PAY_CONFIG = {\n  // 这里需要配置您的微信支付参数\n  appId: \"\", // 微信小程序AppID\n  mchId: \"\", // 商户号\n  apiKey: \"\", // API密钥\n};\n\n/**\n * 获取微信支付参数\n * @param {Object} orderInfo 订单信息\n * @returns {Promise} 支付参数\n */\nexport function getWechatPayParams(orderInfo) {\n  return new Promise((resolve, reject) => {\n    // 调用后端API获取微信支付参数\n    uni.request({\n      url: \"YOUR_API_BASE_URL/api/payment/wechat/create\",\n      method: \"POST\",\n      data: {\n        orderId: orderInfo.orderId,\n        amount: orderInfo.amount,\n        description: orderInfo.description || \"商品购买\",\n      },\n      header: {\n        \"Content-Type\": \"application/json\",\n        Authorization: \"Bearer \" + uni.getStorageSync(\"token\"),\n      },\n      success: (res) => {\n        if (res.statusCode === 200 && res.data.success) {\n          resolve(res.data.data);\n        } else {\n          reject(new Error(res.data.message || \"获取支付参数失败\"));\n        }\n      },\n      fail: (err) => {\n        reject(new Error(\"网络请求失败\"));\n      },\n    });\n  });\n}\n\n/**\n * 调用微信支付\n * @param {Object} payParams 支付参数\n * @returns {Promise} 支付结果\n */\nexport function requestWechatPayment(payParams) {\n  return new Promise((resolve, reject) => {\n    uni.requestPayment({\n      provider: \"wxpay\",\n      timeStamp: payParams.timeStamp,\n      nonceStr: payParams.nonceStr,\n      package: payParams.package,\n      signType: payParams.signType,\n      paySign: payParams.paySign,\n      success: (res) => {\n        resolve({\n          success: true,\n          data: res,\n        });\n      },\n      fail: (err) => {\n        resolve({\n          success: false,\n          error: err,\n        });\n      },\n    });\n  });\n}\n\n/**\n * 验证支付结果\n * @param {Object} orderInfo 订单信息\n * @returns {Promise} 验证结果\n */\nexport function verifyPaymentResult(orderInfo) {\n  return new Promise((resolve, reject) => {\n    uni.request({\n      url: \"YOUR_API_BASE_URL/api/payment/verify\",\n      method: \"POST\",\n      data: {\n        orderId: orderInfo.orderId,\n      },\n      header: {\n        \"Content-Type\": \"application/json\",\n        Authorization: \"Bearer \" + uni.getStorageSync(\"token\"),\n      },\n      success: (res) => {\n        if (res.statusCode === 200 && res.data.success) {\n          resolve(res.data.data);\n        } else {\n          reject(new Error(res.data.message || \"验证支付结果失败\"));\n        }\n      },\n      fail: (err) => {\n        reject(new Error(\"网络请求失败\"));\n      },\n    });\n  });\n}\n\n/**\n * 完整的微信支付流程\n * @param {Object} orderInfo 订单信息\n * @returns {Promise} 支付结果\n */\nexport async function wechatPay(orderInfo) {\n  try {\n    // 1. 获取支付参数\n    const payParams = await getWechatPayParams(orderInfo);\n\n    // 2. 调用微信支付\n    const payResult = await requestWechatPayment(payParams);\n\n    if (payResult.success) {\n      // 3. 验证支付结果\n      const verifyResult = await verifyPaymentResult(orderInfo);\n\n      return {\n        success: true,\n        data: verifyResult,\n      };\n    } else {\n      return {\n        success: false,\n        error: payResult.error,\n      };\n    }\n  } catch (error) {\n    return {\n      success: false,\n      error: error.message,\n    };\n  }\n}\n\n/**\n * 格式化金额\n * @param {number} amount 金额（分）\n * @returns {string} 格式化后的金额\n */\nexport function formatAmount(amount) {\n  return (amount / 100).toFixed(2);\n}\n\n/**\n * 生成随机字符串\n * @param {number} length 字符串长度\n * @returns {string} 随机字符串\n */\nexport function generateNonceStr(length = 32) {\n  const chars =\n    \"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789\";\n  let result = \"\";\n  for (let i = 0; i < length; i++) {\n    result += chars.charAt(Math.floor(Math.random() * chars.length));\n  }\n  return result;\n}\n\n/**\n * 获取错误信息\n * @param {Object} error 错误对象\n * @returns {string} 错误信息\n */\nexport function getErrorMessage(error) {\n  if (typeof error === \"string\") {\n    return error;\n  }\n\n  if (error.errMsg) {\n    if (error.errMsg.includes(\"cancel\")) {\n      return \"支付已取消\";\n    } else if (error.errMsg.includes(\"fail\")) {\n      return \"支付失败，请重试\";\n    } else if (error.errMsg.includes(\"timeout\")) {\n      return \"支付超时，请重试\";\n    }\n  }\n\n  return \"支付失败，请重试\";\n}\n"],"names":["getWechatPayParams","orderInfo","resolve","reject","uni","res","err","requestWechatPayment","payParams","verifyPaymentResult","wechatPay","payResult","error","formatAmount","amount","getErrorMessage"],"mappings":"oDAiBO,SAASA,EAAmBC,EAAW,CAC5C,OAAO,IAAI,QAAQ,CAACC,EAASC,IAAW,CAEtCC,EAAAA,MAAI,QAAQ,CACV,IAAK,8CACL,OAAQ,OACR,KAAM,CACJ,QAASH,EAAU,QACnB,OAAQA,EAAU,OAClB,YAAaA,EAAU,aAAe,MACvC,EACD,OAAQ,CACN,eAAgB,mBAChB,cAAe,UAAYG,QAAI,eAAe,OAAO,CACtD,EACD,QAAUC,GAAQ,CACZA,EAAI,aAAe,KAAOA,EAAI,KAAK,QACrCH,EAAQG,EAAI,KAAK,IAAI,EAErBF,EAAO,IAAI,MAAME,EAAI,KAAK,SAAW,UAAU,CAAC,CAEnD,EACD,KAAOC,GAAQ,CACbH,EAAO,IAAI,MAAM,QAAQ,CAAC,CAC3B,CACP,CAAK,CACL,CAAG,CACH,CAOO,SAASI,EAAqBC,EAAW,CAC9C,OAAO,IAAI,QAAQ,CAACN,EAASC,IAAW,CACtCC,EAAAA,MAAI,eAAe,CACjB,SAAU,QACV,UAAWI,EAAU,UACrB,SAAUA,EAAU,SACpB,QAASA,EAAU,QACnB,SAAUA,EAAU,SACpB,QAASA,EAAU,QACnB,QAAUH,GAAQ,CAChBH,EAAQ,CACN,QAAS,GACT,KAAMG,CAChB,CAAS,CACF,EACD,KAAOC,GAAQ,CACbJ,EAAQ,CACN,QAAS,GACT,MAAOI,CACjB,CAAS,CACF,CACP,CAAK,CACL,CAAG,CACH,CAOO,SAASG,EAAoBR,EAAW,CAC7C,OAAO,IAAI,QAAQ,CAACC,EAASC,IAAW,CACtCC,EAAAA,MAAI,QAAQ,CACV,IAAK,uCACL,OAAQ,OACR,KAAM,CACJ,QAASH,EAAU,OACpB,EACD,OAAQ,CACN,eAAgB,mBAChB,cAAe,UAAYG,QAAI,eAAe,OAAO,CACtD,EACD,QAAUC,GAAQ,CACZA,EAAI,aAAe,KAAOA,EAAI,KAAK,QACrCH,EAAQG,EAAI,KAAK,IAAI,EAErBF,EAAO,IAAI,MAAME,EAAI,KAAK,SAAW,UAAU,CAAC,CAEnD,EACD,KAAOC,GAAQ,CACbH,EAAO,IAAI,MAAM,QAAQ,CAAC,CAC3B,CACP,CAAK,CACL,CAAG,CACH,CAOO,eAAeO,EAAUT,EAAW,CACzC,GAAI,CAEF,MAAMO,EAAY,MAAMR,EAAmBC,CAAS,EAG9CU,EAAY,MAAMJ,EAAqBC,CAAS,EAEtD,OAAIG,EAAU,QAIL,CACL,QAAS,GACT,KAJmB,MAAMF,EAAoBR,CAAS,CAK9D,EAEa,CACL,QAAS,GACT,MAAOU,EAAU,KACzB,CAEG,OAAQC,EAAO,CACd,MAAO,CACL,QAAS,GACT,MAAOA,EAAM,OACnB,CACG,CACH,CAOO,SAASC,EAAaC,EAAQ,CACnC,OAAQA,EAAS,KAAK,QAAQ,CAAC,CACjC,CAsBO,SAASC,EAAgBH,EAAO,CACrC,GAAI,OAAOA,GAAU,SACnB,OAAOA,EAGT,GAAIA,EAAM,OAAQ,CAChB,GAAIA,EAAM,OAAO,SAAS,QAAQ,EAChC,MAAO,QACF,GAAIA,EAAM,OAAO,SAAS,MAAM,EACrC,MAAO,WACF,GAAIA,EAAM,OAAO,SAAS,SAAS,EACxC,MAAO,UAEV,CAED,MAAO,UACT"}