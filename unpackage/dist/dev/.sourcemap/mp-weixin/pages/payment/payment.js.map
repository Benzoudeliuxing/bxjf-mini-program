{"version":3,"file":"payment.js","sources":["pages/payment/payment.vue","pages/payment/payment.vue?type=page"],"sourcesContent":["<template>\n  <view class=\"payment-container\">\n    <!-- 订单信息 -->\n    <view class=\"order-info\">\n      <view class=\"order-header\">\n        <text class=\"order-title\">订单详情</text>\n        <text\n          class=\"order-status\"\n          :class=\"getStatusClass(orderInfo.payStatus)\"\n          >{{ getStatusText(orderInfo.payStatus) }}</text\n        >\n      </view>\n\n      <view class=\"order-item\">\n        <text class=\"label\">订单号：</text>\n        <text class=\"value\">{{ orderInfo.orderNo }}</text>\n      </view>\n      <view class=\"order-item\" v-if=\"false\">\n        <text class=\"label\">商品名称：</text>\n        <text class=\"value\">{{ orderInfo.productName }}</text>\n      </view>\n      <view class=\"order-item\" v-if=\"false\">\n        <text class=\"label\">保险类型：</text>\n        <text class=\"value\">学生意外伤害保险</text>\n      </view>\n      <view class=\"order-item\" v-if=\"false\">\n        <text class=\"label\">保险期限：</text>\n        <text class=\"value\">1年</text>\n      </view>\n      <view class=\"order-item\">\n        <text class=\"label\">订单金额：</text>\n        <text class=\"value price\">¥{{ orderInfo.payPrice }}</text>\n      </view>\n      <view class=\"order-item total-amount\">\n        <text class=\"label\">应付金额：</text>\n        <text class=\"value price total\">¥{{ orderInfo.payPrice }}</text>\n      </view>\n    </view>\n\n    <!-- 投保人信息 -->\n    <view class=\"person-info\">\n      <view class=\"info-title\">投保人信息</view>\n      <view class=\"info-item\">\n        <text class=\"label\">姓名：</text>\n        <text class=\"value\">{{ orderInfo.tbName }}</text>\n      </view>\n      <view class=\"info-item\">\n        <text class=\"label\">身份证号：</text>\n        <text class=\"value\">{{ formatIdCard(orderInfo.tbIdCard) }}</text>\n      </view>\n      <view class=\"info-item\">\n        <text class=\"label\">手机号：</text>\n        <text class=\"value\">{{ orderInfo.tbPhone }}</text>\n      </view>\n      <view class=\"info-item\">\n        <text class=\"label\">住址：</text>\n        <text class=\"value\">{{ orderInfo.tbAddress }}</text>\n      </view>\n    </view>\n\n    <!-- 被保人信息 -->\n    <view class=\"person-info\">\n      <view class=\"info-title\">被保人信息</view>\n      <view class=\"info-item\">\n        <text class=\"label\">姓名：</text>\n        <text class=\"value\">{{ orderInfo.bbName }}</text>\n      </view>\n      <view class=\"info-item\">\n        <text class=\"label\">身份证号：</text>\n        <text class=\"value\">{{ formatIdCard(orderInfo.bbIdCard) }}</text>\n      </view>\n      <view class=\"info-item\">\n        <text class=\"label\">手机号：</text>\n        <text class=\"value\">{{ orderInfo.bbPhone }}</text>\n      </view>\n      <view class=\"info-item\">\n        <text class=\"label\">住址：</text>\n        <text class=\"value\">{{ orderInfo.bbAddress }}</text>\n      </view>\n      <view class=\"info-item\">\n        <text class=\"label\">学校：</text>\n        <text class=\"value\">{{ orderInfo.bbSchool }}</text>\n      </view>\n      <view class=\"info-item\">\n        <text class=\"label\">班级：</text>\n        <text class=\"value\">{{ orderInfo.bbClass }}</text>\n      </view>\n    </view>\n\n    <!-- 支付方式 -->\n    <view class=\"payment-method\" v-if=\"orderInfo.payStatus === 1\">\n      <view class=\"method-title\">选择支付方式</view>\n      <view class=\"method-item\" @click=\"selectPaymentMethod('wechat')\">\n        <view class=\"method-info\">\n          <image\n            class=\"method-icon\"\n            src=\"/static/wechat-pay.png\"\n            mode=\"aspectFit\"\n          ></image>\n          <text class=\"method-name\">微信支付</text>\n        </view>\n        <view class=\"method-check\">\n          <view\n            class=\"check-icon\"\n            :class=\"{ active: selectedMethod === 'wechat' }\"\n          ></view>\n        </view>\n      </view>\n    </view>\n\n    <!-- 支付按钮 -->\n    <view\n      class=\"payment-action\"\n      v-if=\"orderInfo.payStatus === 1 || orderInfo.payStatus == null\"\n    >\n      <button class=\"pay-btn\" @click=\"handlePayment\" :disabled=\"isPaying\">\n        {{ isPaying ? \"支付中...\" : \"立即支付\" }}\n      </button>\n    </view>\n\n    <!-- 已支付状态提示 -->\n    <view class=\"paid-status\" v-if=\"orderInfo.payStatus === 2\">\n      <view class=\"paid-icon\">✓</view>\n      <text class=\"paid-text\">订单已支付完成</text>\n    </view>\n\n    <!-- 退款状态提示 -->\n    <view\n      class=\"refund-status\"\n      v-if=\"orderInfo.payStatus === 3 || orderInfo.payStatus === 4\"\n    >\n      <view class=\"refund-icon\">⟲</view>\n      <text class=\"refund-text\">{{\n        orderInfo.payStatus === 3 ? \"申请退款中\" : \"已完成退款\"\n      }}</text>\n    </view>\n\n    <!-- 支付说明 -->\n    <view class=\"payment-tips\" v-if=\"false\">\n      <text class=\"tips-text\">支付说明：</text>\n      <text class=\"tips-content\">1. 请确保微信已安装并已登录</text>\n      <text class=\"tips-content\">2. 支付完成后请勿关闭小程序</text>\n      <text class=\"tips-content\">3. 如有问题请联系客服</text>\n    </view>\n  </view>\n</template>\n\n<script>\nimport { wechatPay, getErrorMessage } from \"@/utils/payment.js\";\nimport api from \"../../utils/api\";\n\nexport default {\n  name: \"Payment\",\n  data() {\n    return {\n      orderId: 0,\n      orderInfo: {\n        orderId: 0,\n        orderNo: \"\",\n        productName: \"\",\n        amount: 0,\n        payPrice: 0,\n        payStatus: 1,\n        tbName: \"\",\n        tbIdCard: \"\",\n        tbPhone: \"\",\n        tbAddress: \"\",\n        bbName: \"\",\n        bbIdCard: \"\",\n        bbPhone: \"\",\n        bbAddress: \"\",\n        bbSchool: \"\",\n        bbClass: \"\",\n      },\n      selectedMethod: \"wechat\",\n      isPaying: false,\n    };\n  },\n  onLoad(options) {\n    // 获取订单信息\n    this.getOrderInfo(options);\n  },\n  methods: {\n    // 获取订单信息\n    getOrderInfo(options) {\n      console.log(\"支付页面接收到的参数:\", options);\n\n      // 从页面参数获取订单信息，确保转换为整数类型\n      this.orderId = parseInt(options.id);\n\n      api.business.getOrderDetail({ id: this.orderId }).then((res) => {\n        console.log(\"订单信息:\", res);\n        if (res.code == 0) {\n          this.orderInfo = res.data;\n        }\n      });\n    },\n\n    // 获取支付状态文本\n    getStatusText(status) {\n      const statusMap = {\n        1: \"待支付\",\n        2: \"已支付\",\n        3: \"申请退款\",\n        4: \"已退款\",\n      };\n      // 当status为null、undefined或其他值时，默认为待支付\n      return statusMap[status] || \"待支付\";\n    },\n\n    // 获取支付状态样式类\n    getStatusClass(status) {\n      const classMap = {\n        1: \"status-pending\",\n        2: \"status-paid\",\n        3: \"status-refunding\",\n        4: \"status-refunded\",\n      };\n      // 当status为null、undefined或其他值时，默认为待支付样式\n      return classMap[status] || \"status-pending\";\n    },\n\n    // 格式化身份证号（隐藏中间部分）\n    formatIdCard(idCard) {\n      if (!idCard || idCard.length < 10) return idCard;\n      return (\n        idCard.substring(0, 6) + \"****\" + idCard.substring(idCard.length - 4)\n      );\n    },\n\n    // 选择支付方式\n    selectPaymentMethod(method) {\n      this.selectedMethod = method;\n    },\n\n    // 处理支付\n    async handlePayment() {\n      if (this.isPaying) return;\n\n      // 验证orderId是否有效\n      if (!this.orderId || this.orderId <= 0) {\n        uni.showToast({\n          title: \"订单信息错误\",\n          icon: \"none\",\n        });\n        return;\n      }\n\n      this.isPaying = true;\n\n      try {\n        // 调用微信支付，确保orderId为整数类型\n        const orderId = parseInt(this.orderId);\n        const result = await wechatPay({ orderId: orderId });\n\n        if (result.success) {\n          this.paymentSuccess();\n        } else {\n          this.paymentFail(result.error);\n        }\n      } catch (error) {\n        this.paymentFail(error);\n      } finally {\n        this.isPaying = false;\n      }\n    },\n\n    // 支付成功\n    paymentSuccess() {\n      uni.showToast({\n        title: \"支付成功\",\n        icon: \"success\",\n      });\n\n      // 跳转到支付成功页面，传递更多订单信息\n      setTimeout(() => {\n        const successParams = {\n          orderId: this.orderInfo.orderId,\n          orderNo: this.orderInfo.orderNo,\n          amount: this.orderInfo.payPrice,\n          productName: this.orderInfo.productName,\n        };\n\n        const queryString = Object.keys(successParams)\n          .map((key) => `${key}=${encodeURIComponent(successParams[key])}`)\n          .join(\"&\");\n\n        uni.redirectTo({\n          url: `/pages/payment-success/payment-success?${queryString}`,\n        });\n      }, 1500);\n    },\n\n    // 支付失败\n    paymentFail(error) {\n      const message = getErrorMessage(error);\n\n      uni.showToast({\n        title: message,\n        icon: \"none\",\n      });\n    },\n  },\n};\n</script>\n\n<style scoped>\n.payment-container {\n  min-height: 100vh;\n  background-color: #f5f5f5;\n  padding: 20rpx;\n}\n\n.header {\n  text-align: center;\n  padding: 40rpx 0;\n  background-color: #fff;\n  border-radius: 20rpx;\n  margin-bottom: 20rpx;\n}\n\n.title {\n  font-size: 36rpx;\n  font-weight: bold;\n  color: #333;\n}\n\n.order-info {\n  background-color: #fff;\n  border-radius: 20rpx;\n  padding: 40rpx;\n  margin-bottom: 20rpx;\n}\n\n.order-header {\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  margin-bottom: 30rpx;\n  padding-bottom: 20rpx;\n  border-bottom: 2rpx solid #f0f0f0;\n}\n\n.order-title {\n  font-size: 32rpx;\n  font-weight: bold;\n  color: #333;\n}\n\n.order-status {\n  font-size: 26rpx;\n  padding: 8rpx 16rpx;\n  border-radius: 20rpx;\n  border: 1rpx solid;\n}\n\n.status-pending {\n  color: #ff6b35;\n  background-color: #fff2ee;\n  border-color: #ffdbcc;\n}\n\n.status-paid {\n  color: #07c160;\n  background-color: #f0f9ff;\n  border-color: #b3e5fc;\n}\n\n.status-refunding {\n  color: #ffa726;\n  background-color: #fff8e1;\n  border-color: #ffcc02;\n}\n\n.status-refunded {\n  color: #9e9e9e;\n  background-color: #f5f5f5;\n  border-color: #e0e0e0;\n}\n\n.order-item {\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  padding: 20rpx 0;\n  border-bottom: 1rpx solid #f0f0f0;\n}\n\n.order-item:last-child {\n  border-bottom: none;\n}\n\n.label {\n  font-size: 28rpx;\n  color: #666;\n}\n\n.value {\n  font-size: 28rpx;\n  color: #333;\n}\n\n.price {\n  color: #ff6b35;\n  font-weight: bold;\n  font-size: 32rpx;\n}\n\n.total-amount {\n  background-color: #f8f9fa;\n  margin: 20rpx -20rpx -20rpx -20rpx;\n  padding: 20rpx;\n  border-radius: 0 0 20rpx 20rpx;\n}\n\n.total-amount .label {\n  font-size: 30rpx;\n  font-weight: bold;\n}\n\n.total-amount .price.total {\n  font-size: 36rpx;\n  color: #ff4757;\n}\n\n/* 人员信息样式 */\n.person-info {\n  background-color: #fff;\n  border-radius: 20rpx;\n  padding: 40rpx;\n  margin-bottom: 20rpx;\n}\n\n.info-title {\n  font-size: 32rpx;\n  font-weight: bold;\n  color: #333;\n  margin-bottom: 30rpx;\n  padding-bottom: 20rpx;\n  border-bottom: 2rpx solid #f0f0f0;\n}\n\n.info-item {\n  display: flex;\n  justify-content: space-between;\n  align-items: flex-start;\n  padding: 20rpx 0;\n  border-bottom: 1rpx solid #f0f0f0;\n}\n\n.info-item:last-child {\n  border-bottom: none;\n}\n\n.info-item .label {\n  font-size: 28rpx;\n  color: #666;\n  min-width: 120rpx;\n  flex-shrink: 0;\n}\n\n.info-item .value {\n  font-size: 28rpx;\n  color: #333;\n  text-align: right;\n  word-break: break-all;\n  flex: 1;\n  margin-left: 20rpx;\n}\n\n.payment-method {\n  background-color: #fff;\n  border-radius: 20rpx;\n  padding: 40rpx;\n  margin-bottom: 20rpx;\n}\n\n.method-title {\n  font-size: 32rpx;\n  font-weight: bold;\n  color: #333;\n  margin-bottom: 30rpx;\n}\n\n.method-item {\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  padding: 30rpx 0;\n  border-bottom: 1rpx solid #f0f0f0;\n}\n\n.method-info {\n  display: flex;\n  align-items: center;\n}\n\n.method-icon {\n  width: 60rpx;\n  height: 60rpx;\n  margin-right: 20rpx;\n}\n\n.method-name {\n  font-size: 30rpx;\n  color: #333;\n}\n\n.method-check {\n  display: flex;\n  align-items: center;\n}\n\n.check-icon {\n  width: 40rpx;\n  height: 40rpx;\n  border: 2rpx solid #ddd;\n  border-radius: 50%;\n  position: relative;\n}\n\n.check-icon.active {\n  border-color: #07c160;\n  background-color: #07c160;\n}\n\n.check-icon.active::after {\n  content: \"\";\n  position: absolute;\n  top: 50%;\n  left: 50%;\n  transform: translate(-50%, -50%);\n  width: 20rpx;\n  height: 20rpx;\n  background-color: #fff;\n  border-radius: 50%;\n}\n\n.payment-action {\n  margin-bottom: 20rpx;\n}\n\n.pay-btn {\n  width: 100%;\n  height: 100rpx;\n  background: linear-gradient(135deg, #07c160, #10ad6a);\n  color: #fff;\n  border: none;\n  border-radius: 50rpx;\n  font-size: 32rpx;\n  font-weight: bold;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n}\n\n.pay-btn:disabled {\n  background: #ccc;\n}\n\n/* 已支付状态样式 */\n.paid-status {\n  background-color: #fff;\n  border-radius: 20rpx;\n  padding: 60rpx 40rpx;\n  margin-bottom: 20rpx;\n  text-align: center;\n}\n\n.paid-icon {\n  font-size: 80rpx;\n  color: #07c160;\n  margin-bottom: 20rpx;\n}\n\n.paid-text {\n  font-size: 32rpx;\n  color: #07c160;\n  font-weight: bold;\n}\n\n/* 退款状态样式 */\n.refund-status {\n  background-color: #fff;\n  border-radius: 20rpx;\n  padding: 60rpx 40rpx;\n  margin-bottom: 20rpx;\n  text-align: center;\n}\n\n.refund-icon {\n  font-size: 80rpx;\n  color: #ffa726;\n  margin-bottom: 20rpx;\n}\n\n.refund-text {\n  font-size: 32rpx;\n  color: #ffa726;\n  font-weight: bold;\n}\n\n.payment-tips {\n  background-color: #fff;\n  border-radius: 20rpx;\n  padding: 40rpx;\n}\n\n.tips-text {\n  font-size: 28rpx;\n  color: #333;\n  font-weight: bold;\n  margin-bottom: 20rpx;\n  display: block;\n}\n\n.tips-content {\n  font-size: 26rpx;\n  color: #666;\n  line-height: 1.6;\n  display: block;\n  margin-bottom: 10rpx;\n}\n</style>\n","import MiniProgramPage from '/Users/will/Documents/WillProject/Uni-App/bxjf-mini-program/pages/payment/payment.vue'\nwx.createPage(MiniProgramPage)"],"names":["_sfc_main","options","uni","api","res","status","idCard","method","orderId","result","wechatPay","error","successParams","queryString","key","message","getErrorMessage","MiniProgramPage"],"mappings":"+JAuJKA,EAAU,CACb,KAAM,UACN,MAAO,CACL,MAAO,CACL,QAAS,EACT,UAAW,CACT,QAAS,EACT,QAAS,GACT,YAAa,GACb,OAAQ,EACR,SAAU,EACV,UAAW,EACX,OAAQ,GACR,SAAU,GACV,QAAS,GACT,UAAW,GACX,OAAQ,GACR,SAAU,GACV,QAAS,GACT,UAAW,GACX,SAAU,GACV,QAAS,EACV,EACD,eAAgB,SAChB,SAAU,GAEb,EACD,OAAOC,EAAS,CAEd,KAAK,aAAaA,CAAO,CAC1B,EACD,QAAS,CAEP,aAAaA,EAAS,CACpBC,EAAA,MAAA,MAAA,MAAA,mCAAY,cAAeD,CAAO,EAGlC,KAAK,QAAU,SAASA,EAAQ,EAAE,EAElCE,MAAI,SAAS,eAAe,CAAE,GAAI,KAAK,QAAS,EAAE,KAAMC,GAAQ,CAC9DF,uDAAY,QAASE,CAAG,EACpBA,EAAI,MAAQ,IACd,KAAK,UAAYA,EAAI,KAEzB,CAAC,CACF,EAGD,cAAcC,EAAQ,CAQpB,MAPkB,CAChB,EAAG,MACH,EAAG,MACH,EAAG,OACH,EAAG,OAGYA,CAAM,GAAK,KAC7B,EAGD,eAAeA,EAAQ,CAQrB,MAPiB,CACf,EAAG,iBACH,EAAG,cACH,EAAG,mBACH,EAAG,mBAGWA,CAAM,GAAK,gBAC5B,EAGD,aAAaC,EAAQ,CACnB,MAAI,CAACA,GAAUA,EAAO,OAAS,GAAWA,EAExCA,EAAO,UAAU,EAAG,CAAC,EAAI,OAASA,EAAO,UAAUA,EAAO,OAAS,CAAC,CAEvE,EAGD,oBAAoBC,EAAQ,CAC1B,KAAK,eAAiBA,CACvB,EAGD,MAAM,eAAgB,CACpB,GAAI,MAAK,SAGT,IAAI,CAAC,KAAK,SAAW,KAAK,SAAW,EAAG,CACtCL,EAAAA,MAAI,UAAU,CACZ,MAAO,SACP,KAAM,MACR,CAAC,EACD,MACF,CAEA,KAAK,SAAW,GAEhB,GAAI,CAEF,MAAMM,EAAU,SAAS,KAAK,OAAO,EAC/BC,EAAS,MAAMC,EAAS,UAAC,CAAE,QAASF,CAAS,CAAA,EAE/CC,EAAO,QACT,KAAK,eAAc,EAEnB,KAAK,YAAYA,EAAO,KAAK,CAE/B,OAAOE,EAAO,CACd,KAAK,YAAYA,CAAK,CACxB,QAAU,CACR,KAAK,SAAW,EAClB,EACD,EAGD,gBAAiB,CACfT,EAAAA,MAAI,UAAU,CACZ,MAAO,OACP,KAAM,SACR,CAAC,EAGD,WAAW,IAAM,CACf,MAAMU,EAAgB,CACpB,QAAS,KAAK,UAAU,QACxB,QAAS,KAAK,UAAU,QACxB,OAAQ,KAAK,UAAU,SACvB,YAAa,KAAK,UAAU,aAGxBC,EAAc,OAAO,KAAKD,CAAa,EAC1C,IAAKE,GAAQ,GAAGA,CAAG,IAAI,mBAAmBF,EAAcE,CAAG,CAAC,CAAC,EAAE,EAC/D,KAAK,GAAG,EAEXZ,EAAAA,MAAI,WAAW,CACb,IAAK,0CAA0CW,CAAW,EAC5D,CAAC,CACF,EAAE,IAAI,CACR,EAGD,YAAYF,EAAO,CACjB,MAAMI,EAAUC,kBAAgBL,CAAK,EAErCT,EAAAA,MAAI,UAAU,CACZ,MAAOa,EACP,KAAM,MACR,CAAC,CACF,CACF,CACH,wrCC9SA,GAAG,WAAWE,CAAe"}